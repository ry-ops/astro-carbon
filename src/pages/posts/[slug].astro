---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SocialShare from '../../components/SocialShare.astro';
import ForkOnGitHub from '../../components/ForkOnGitHub.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import GitHubProjects from '../../components/GitHubProjects.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import SeriesNavigator from '../../components/SeriesNavigator.astro';
import KoFiSupport from '../../components/KoFiSupport.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time (average 200 words per minute)
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Construct full URL for sharing
const siteUrl = Astro.site || 'http://localhost:4321';
const postUrl = new URL(`/posts/${post.slug}`, siteUrl).toString();
const ampUrl = new URL(`/amp/${post.slug}`, siteUrl).toString();
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.hero?.image || post.data.image}
  article={true}
  author={post.data.author.name}
  publishedTime={post.data.date.toISOString()}
  tags={post.data.tags}
  canonicalURL={postUrl}
  ampURL={ampUrl}
>
  <Header />

  <article class="py-8">
    <!-- Breadcrumb -->
    <div class="content-constrained px-4 sm:px-6 lg:px-8 mb-6">
      <nav class="flex items-center gap-2" style="font-size: var(--font-size-sm); color: var(--text-secondary);">
        <a href="/" class="hover:underline">Home</a>
        <span>→</span>
        <a href={`/category/${post.data.category.toLowerCase().replace(/&/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '')}`} class="hover:underline">
          {post.data.category}
        </a>
        <span>→</span>
        <span style="color: var(--text-primary);">{post.data.title}</span>
      </nav>
    </div>

    <!-- Main Content Grid -->
    <div class="content-constrained px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-8">
          <!-- Header -->
          <header class="mb-8">
            <!-- Category Badge -->
            <div class="mb-4">
              <span class="category-badge inline-block px-4 py-2 rounded-full">
                {post.data.category}
              </span>
            </div>

            <!-- Title -->
            <h1 class="font-bold mb-6 leading-tight" style="font-size: var(--font-size-5xl); line-height: var(--line-height-tight); color: var(--text-primary);">
              {post.data.title}
            </h1>

            <!-- Meta & Share -->
            <div class="flex flex-wrap items-center justify-between gap-4 pb-6" style="border-bottom: 1px solid var(--border-default);">
              <div class="flex items-center gap-4">
                {post.data.author.avatar && (
                  <img
                    src={post.data.author.avatar}
                    alt={post.data.author.name}
                    class="w-16 h-16 rounded-full p-4"
                    style="object-fit: contain;"
                  />
                )}
                <div>
                  <div class="font-semibold" style="font-size: var(--font-size-md); color: var(--text-primary);">
                    {post.data.author.name}
                  </div>
                  <div class="flex items-center gap-2" style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                    <span>{formattedDate}</span>
                    <span>•</span>
                    <span>{readingTime} min read</span>
                  </div>
                </div>
              </div>

              <SocialShare
                url={postUrl}
                title={post.data.title}
                description={post.data.description}
              />
            </div>
          </header>

          <!-- Featured Image -->
          <div class="mb-12 rounded-lg overflow-hidden" style="border: 1px solid var(--border-default);">
            <img
              src={post.data.hero?.image || post.data.image}
              alt={post.data.title}
              class="w-full h-auto"
              loading="eager"
              decoding="async"
              fetchpriority="high"
            />
            {(post.data.hero?.attribution || post.data.imageCredit) && (
              <div class="px-4 py-2" style="font-size: var(--font-size-xs); background-color: var(--bg-secondary); color: var(--text-secondary);">
                {post.data.hero?.generated ? (
                  <span>Custom generated image</span>
                ) : post.data.hero?.attribution ? (
                  <>Photo by <a
                    href={post.data.hero.attribution.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline hover:no-underline"
                    style="color: var(--text-link);"
                  >
                    {post.data.hero.attribution.name}
                  </a> on <a
                    href="https://unsplash.com"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline hover:no-underline"
                    style="color: var(--text-link);"
                  >
                    Unsplash
                  </a></>
                ) : post.data.imageCredit ? (
                  <>Photo by <a
                    href={`https://unsplash.com/@${post.data.imageCredit.username}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline hover:no-underline"
                    style="color: var(--text-link);"
                  >
                    {post.data.imageCredit.photographer}
                  </a> on <a
                    href="https://unsplash.com"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="underline hover:no-underline"
                    style="color: var(--text-link);"
                  >
                    Unsplash
                  </a></>
                ) : null}
              </div>
            )}
          </div>


          <!-- Article Content -->
          <div class="prose prose-invert prose-lg max-w-none">
            <Content />
          </div>



          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="mt-12 pt-8" style="border-top: 1px solid var(--border-default);">
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map((tag) => (
                  <span
                    class="px-3 py-1 rounded-full"
                    style="font-size: var(--font-size-sm); background-color: var(--bg-overlay); color: var(--text-secondary);"
                  >
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          )}

          <!-- Bottom CTA -->
          {post.data.repo && (
            <div class="mt-12 rounded-lg p-8" style="background-color: var(--bg-secondary); border: 1px solid var(--border-default);">
              <h3 class="font-bold mb-4" style="font-size: var(--font-size-2xl); color: var(--text-primary);">
                Explore {post.data.repo.name} on GitHub
              </h3>
              <p class="mb-6" style="font-size: var(--font-size-md); color: var(--text-secondary);">
                Check out the source code, documentation, and contribute to the project.
              </p>
              <div class="flex flex-wrap gap-4">
                <a
                  href={post.data.repo.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center px-6 py-3 rounded-md font-semibold transition-colors"
                  style="background-color: var(--accent-emphasis); color: white;"
                  onmouseover="this.style.backgroundColor='var(--accent-primary)'"
                  onmouseout="this.style.backgroundColor='var(--accent-emphasis)'"
                >
                  View on GitHub
                  <svg class="ml-2 w-5 h-5" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                  </svg>
                </a>
                <a
                  href="/"
                  class="inline-flex items-center px-6 py-3 rounded-md font-semibold transition-colors"
                  style="border: 1px solid var(--border-default); color: var(--text-primary);"
                >
                  Back to Blog
                </a>
              </div>
            </div>
          )}
        </div>

        <!-- Sidebar - Sticky on scroll -->
        <aside class="lg:col-span-4">
          <div class="sticky-sidebar space-y-6">
            <!-- Author Card -->
            <AuthorCard
              name={post.data.author.name}
              avatar={post.data.author.avatar}
              github="ry-ops"
            />

            <!-- Ko-Fi Support -->
            <KoFiSupport />

            <!-- Series Navigator (if part of series) -->
            {post.data.series && (
              <SeriesNavigator
                currentSlug={post.slug}
                series={post.data.series}
              />
            )}

            <!-- Fork on GitHub (if repo exists) -->
            {post.data.repo && (
              <ForkOnGitHub
                repoUrl={post.data.repo.url}
                repoName={post.data.repo.name}
                stars={post.data.repo.stars}
              />
            )}

            <!-- Related Posts -->
            <RelatedPosts
              currentSlug={post.slug}
              currentCategory={post.data.category}
              currentTags={post.data.tags}
              limit={3}
            />

            <!-- GitHub Projects -->
            <GitHubProjects />
          </div>
        </aside>
      </div>
    </div>
  </article>

  <Footer />
</Layout>

<style>
  /* Sticky sidebar that follows scroll */
  .sticky-sidebar {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
  }

  /* Hide scrollbar for Chrome, Safari and Opera */
  .sticky-sidebar::-webkit-scrollbar {
    display: none;
  }
  .prose {
    color: var(--text-secondary);
    font-size: var(--font-size-xl);
    line-height: var(--line-height-relaxed);
  }

  .prose :global(h1),
  .prose :global(h2),
  .prose :global(h3),
  .prose :global(h4),
  .prose :global(h5),
  .prose :global(h6) {
    color: var(--text-primary);
    font-weight: 700;
    margin-top: 2em;
    margin-bottom: 0.75em;
    scroll-margin-top: 6rem;
    line-height: var(--line-height-tight);
  }

  .prose :global(h2) {
    font-size: var(--font-size-4xl);
    border-bottom: 1px solid var(--border-default);
    padding-bottom: 0.5em;
  }

  .prose :global(h3) {
    font-size: var(--font-size-3xl);
  }

  .prose :global(h4) {
    font-size: var(--font-size-2xl);
  }

  .prose :global(h5) {
    font-size: var(--font-size-xl);
  }

  .prose :global(h6) {
    font-size: var(--font-size-lg);
  }

  .prose :global(p) {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    font-size: var(--font-size-xl);
    line-height: var(--line-height-relaxed);
  }

  .prose :global(a) {
    color: var(--text-link);
    text-decoration: none;
    transition: color 0.2s;
  }

  .prose :global(a:hover) {
    color: var(--text-link-hover);
    text-decoration: underline;
  }

  .prose :global(strong) {
    color: var(--text-primary);
    font-weight: 600;
  }

  .prose :global(code) {
    background-color: var(--bg-overlay);
    color: #39ff14;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: var(--font-size-base);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .prose :global(pre) {
    background-color: #0d1117;
    border: 1px solid var(--border-default);
    border-radius: 0.5rem;
    padding: 1.5rem;
    overflow-x: auto;
    margin: 2em 0;
  }

  .prose :global(pre code) {
    background-color: transparent;
    color: #39ff14;
    padding: 0;
    font-size: var(--font-size-base);
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--accent-primary);
    padding-left: 1.5rem;
    margin: 2em 0;
    font-style: italic;
    color: var(--text-secondary);
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 1.5em 0;
    padding-left: 1.5em;
  }

  .prose :global(li) {
    margin: 0.5em 0;
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--border-default);
    margin: 3em 0;
  }

  .prose :global(img) {
    border-radius: 0.5rem;
    margin: 2em 0;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2em 0;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--border-default);
    padding: 0.75rem;
    text-align: left;
  }

  .prose :global(th) {
    background-color: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-primary);
  }
</style>
