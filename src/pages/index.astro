---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroFeatured from '../components/HeroFeatured.astro';
import ChangelogPreview from '../components/ChangelogPreview.astro';
import ChangelogTimeline from '../components/ChangelogTimeline.astro';
import CategorySpotlight from '../components/CategorySpotlight.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';

// Get all blog posts from content collection, excluding Docs category and future posts
const now = new Date();
const allPosts = await getCollection('posts', ({ data }) => {
  return data.category !== 'Docs' && data.date <= now;
});

// Sort by date (newest first)
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get featured posts for hero (prefer featured flag, then newest)
const featuredPosts = sortedPosts.filter(post => post.data.featured);
const nonFeaturedPosts = sortedPosts.filter(post => !post.data.featured);

// Hero: 1 large + 1 small left + 3 small right = 5 posts (featured first, then newest)
const heroPosts = [
  ...(featuredPosts.length >= 5 ? featuredPosts.slice(0, 5) : featuredPosts),
  ...nonFeaturedPosts.slice(0, Math.max(0, 5 - featuredPosts.length))
].slice(0, 5);

// Latest posts: next 3 posts after hero
const usedSlugs = new Set(heroPosts.map(p => p.slug));
const remainingForMore = sortedPosts.filter(p => !usedSlugs.has(p.slug));
const latestPosts = remainingForMore.slice(0, 3);

// Popular posts: older featured posts or posts from varied categories
latestPosts.forEach(p => usedSlugs.add(p.slug));
const remainingForPopular = sortedPosts.filter(p => !usedSlugs.has(p.slug));
// Prioritize featured posts, then get variety from different categories
const popularCandidates = [
  ...remainingForPopular.filter(p => p.data.featured),
  ...remainingForPopular.filter(p => !p.data.featured)
];
const popularPosts = popularCandidates.slice(0, 3);

// AI & ML spotlight posts (1 large + 4 in 2x2 grid = 5 total)
const aiMlPosts = sortedPosts
  .filter(post => post.data.category === 'AI & ML')
  .slice(0, 5);

// Changelog updates for timeline
const changelogUpdates = [
  {
    title: 'GitHub Blog-style homepage redesign with hero layout',
    date: 'December 6, 2025',
  },
  {
    title: 'Added client-side search with Cmd+K shortcut',
    date: 'December 5, 2025',
  },
  {
    title: 'Dynamic featured posts in mega menu navigation',
    date: 'December 5, 2025',
  },
  {
    title: 'Security & Content Expansion - Prompt injection protection',
    date: 'November 26, 2025',
  },
];

// Helper function to format post data
function formatPost(post: typeof sortedPosts[0]) {
  return {
    title: post.data.title,
    description: post.data.description,
    category: post.data.category,
    date: post.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
    author: post.data.author,
    image: post.data.hero?.image || post.data.image,
    href: `/posts/${post.slug}`,
  };
}

const heroPostsFormatted = heroPosts.map(formatPost);
const latestPostsFormatted = latestPosts.map(formatPost);
const popularPostsFormatted = popularPosts.map(formatPost);
const aiMlPostsFormatted = aiMlPosts.map(formatPost);
---

<Layout title="ry-ops | AI-Powered Development & Engineering Insights">
  <Header />

  <main id="main-content" class="content-constrained px-4 sm:px-6 lg:px-8 py-12" role="main">
    <!-- Hero: 1 Large + 1 Small Left + 3 Small Right (GitHub Blog style) -->
    {heroPostsFormatted.length >= 5 && (
      <HeroFeatured posts={heroPostsFormatted} />
    )}

    <!-- Changelog Preview (with gradient transition) -->
    <ChangelogPreview />

    <!-- Purple gradient transition -->
    <div class="purple-gradient-transition"></div>

    <!-- Latest & Popular Section -->
    <section class="posts-section" aria-label="Latest and Popular posts">
      <div class="posts-columns">
        <!-- Latest Posts Column -->
        <div class="posts-column">
          <div class="posts-column-header">
            <h2 class="posts-column-title">Latest</h2>
            <a href="/posts" class="posts-column-link">
              View all
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
          <div class="posts-column-list">
            {latestPostsFormatted.map((post) => (
              <a href={post.href} class="posts-column-item">
                <div class="posts-column-item-image">
                  {post.image && <img src={post.image} alt="" loading="lazy" />}
                </div>
                <div class="posts-column-item-content">
                  <span class="posts-column-item-category">{post.category}</span>
                  <h3 class="posts-column-item-title">{post.title}</h3>
                  <time class="posts-column-item-date">{post.date}</time>
                </div>
              </a>
            ))}
          </div>
        </div>

        <!-- Popular Posts Column -->
        <div class="posts-column">
          <div class="posts-column-header">
            <h2 class="posts-column-title">Popular</h2>
            <a href="/posts" class="posts-column-link">
              View all
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
          <div class="posts-column-list">
            {popularPostsFormatted.map((post) => (
              <a href={post.href} class="posts-column-item">
                <div class="posts-column-item-image">
                  {post.image && <img src={post.image} alt="" loading="lazy" />}
                </div>
                <div class="posts-column-item-content">
                  <span class="posts-column-item-category">{post.category}</span>
                  <h3 class="posts-column-item-title">{post.title}</h3>
                  <time class="posts-column-item-date">{post.date}</time>
                </div>
              </a>
            ))}
          </div>
        </div>
      </div>

      <!-- Changelog Timeline -->
      <ChangelogTimeline items={changelogUpdates} />
    </section>

    <!-- AI & ML Category Spotlight -->
    {aiMlPostsFormatted.length > 0 && (
      <CategorySpotlight
        categoryName="AI & ML"
        categorySlug="ai-ml"
        posts={aiMlPostsFormatted}
      />
    )}

  </main>

  <Footer />
</Layout>

<style>
  /* Purple gradient transition from dark to light */
  .purple-gradient-transition {
    height: 80px;
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    background: linear-gradient(
      180deg,
      var(--bg-primary) 0%,
      #1a1033 25%,
      #2d1f4e 50%,
      #6b5b8a 80%,
      #f0f3f6 100%
    );
  }

  /* Latest & Popular Section - Light background (GitHub Blog style) */
  .posts-section {
    padding: 4rem 0;
    background-color: #f0f3f6;
    /* Break out of constrained container to full width */
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    padding-left: max(1rem, calc((100vw - var(--content-max-width)) / 2 + 1rem));
    padding-right: max(1rem, calc((100vw - var(--content-max-width)) / 2 + 1rem));
  }

  @media (min-width: 640px) {
    .posts-section {
      padding-left: max(1.5rem, calc((100vw - var(--content-max-width)) / 2 + 1.5rem));
      padding-right: max(1.5rem, calc((100vw - var(--content-max-width)) / 2 + 1.5rem));
    }
  }

  @media (min-width: 1024px) {
    .posts-section {
      padding-left: max(2rem, calc((100vw - var(--content-max-width)) / 2 + 2rem));
      padding-right: max(2rem, calc((100vw - var(--content-max-width)) / 2 + 2rem));
    }
  }

  .posts-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
  }

  .posts-column-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #d0d7de;
  }

  .posts-column-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: #1f2328;
    margin: 0;
  }

  .posts-column-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--accent-primary);
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .posts-column-link:hover {
    opacity: 0.8;
  }

  .posts-column-link svg {
    transition: transform 0.2s ease;
  }

  .posts-column-link:hover svg {
    transform: translateX(4px);
  }

  .posts-column-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .posts-column-item {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 1rem;
    padding: 1rem;
    background-color: #ffffff;
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }

  .posts-column-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .posts-column-item-image {
    width: 100px;
    height: 70px;
    border-radius: 6px;
    overflow: hidden;
    background-color: #e1e5e9;
    flex-shrink: 0;
  }

  .posts-column-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .posts-column-item-content {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .posts-column-item-category {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .posts-column-item-title {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: #1f2328;
    line-height: 1.35;
    margin: 0 0 0.375rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color 0.2s ease;
  }

  .posts-column-item:hover .posts-column-item-title {
    color: var(--accent-primary);
  }

  .posts-column-item-date {
    font-size: 12px;
    color: #656d76;
    margin-top: auto;
  }

  /* Responsive */
  @media (max-width: 1023px) {
    .posts-columns {
      gap: 2rem;
    }
  }

  @media (max-width: 767px) {
    .posts-columns {
      grid-template-columns: 1fr;
      gap: 2.5rem;
    }

    .posts-column-item {
      grid-template-columns: 80px 1fr;
    }

    .posts-column-item-image {
      width: 80px;
      height: 55px;
    }
  }
</style>
