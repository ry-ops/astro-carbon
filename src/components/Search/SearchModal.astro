---
// SearchModal - GitHub-style search overlay
---

<div id="search-modal" class="search-modal" role="dialog" aria-modal="true" aria-labelledby="search-title">
  <div class="search-backdrop"></div>
  <div class="search-container">
    <div class="search-header">
      <div class="search-input-wrapper">
        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          id="search-input"
          class="search-input"
          placeholder="Search posts..."
          autocomplete="off"
          aria-label="Search posts"
        />
        <kbd class="search-shortcut">ESC</kbd>
      </div>
    </div>
    <div id="search-results" class="search-results">
      <div class="search-empty">
        <p>Start typing to search...</p>
        <div class="search-tips">
          <span><kbd>↑</kbd> <kbd>↓</kbd> to navigate</span>
          <span><kbd>Enter</kbd> to select</span>
          <span><kbd>ESC</kbd> to close</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal.active {
    display: flex;
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 640px;
    max-height: 70vh;
    margin: 0 1rem;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: 12px;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .search-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border-default);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: var(--bg-primary);
    border: 1px solid var(--border-default);
    border-radius: 8px;
    padding: 0.75rem 1rem;
  }

  .search-input-wrapper:focus-within {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(6, 147, 227, 0.15);
  }

  .search-icon {
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    font-size: var(--font-size-md);
    color: var(--text-primary);
    font-family: inherit;
  }

  .search-input::placeholder {
    color: var(--text-secondary);
  }

  .search-shortcut {
    padding: 0.25rem 0.5rem;
    font-size: var(--font-size-xs);
    font-family: monospace;
    color: var(--text-secondary);
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-default);
    border-radius: 4px;
  }

  .search-results {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .search-empty {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-secondary);
  }

  .search-empty p {
    margin-bottom: 1rem;
    font-size: var(--font-size-base);
  }

  .search-tips {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    font-size: var(--font-size-xs);
  }

  .search-tips kbd {
    padding: 0.125rem 0.375rem;
    font-family: monospace;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-default);
    border-radius: 3px;
  }

  /* Search result items - matching mega menu featured post style */
  .search-result-item {
    display: flex;
    gap: 12px;
    padding: 0.75rem;
    border-radius: 6px;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.15s ease, opacity 0.15s ease;
  }

  .search-result-item:hover,
  .search-result-item.selected {
    background-color: var(--bg-tertiary);
  }

  .search-result-item.selected {
    outline: 2px solid var(--accent-primary);
    outline-offset: -2px;
  }

  .search-result-item:hover {
    opacity: 0.9;
  }

  .search-result-image {
    width: 100px;
    aspect-ratio: 16 / 9;
    border-radius: 6px;
    object-fit: cover;
    background-color: var(--bg-tertiary);
    flex-shrink: 0;
  }

  .search-result-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .search-result-category {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .search-result-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-result-item:hover .search-result-title {
    color: var(--accent-primary);
  }

  .search-result-description {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .search-no-results {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--text-secondary);
  }

  .search-no-results p {
    font-size: var(--font-size-base);
  }

  /* Responsive */
  @media (max-width: 640px) {
    .search-modal {
      padding-top: 0;
    }

    .search-container {
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
    }

    .search-tips {
      flex-direction: column;
      gap: 0.5rem;
    }

    .search-result-image {
      width: 80px;
    }

    .search-result-title {
      -webkit-line-clamp: 1;
    }

    .search-result-description {
      -webkit-line-clamp: 1;
    }
  }
</style>

<script is:inline>
  (function() {
    // Prevent multiple initializations
    if (window.__searchInitialized) return;
    window.__searchInitialized = true;

    let searchIndex = [];
    let selectedIndex = -1;
    let searchResults = [];
    let isLoading = false;

    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');

    // Load search index
    async function loadSearchIndex() {
      if (searchIndex.length > 0 || isLoading) return;
      isLoading = true;
      try {
        const response = await fetch('/search-index.json');
        searchIndex = await response.json();
        // Re-run search if there's already a query
        if (input && input.value.trim()) {
          performSearch(input.value);
        }
      } catch (error) {
        console.error('Failed to load search index:', error);
      } finally {
        isLoading = false;
      }
    }

    // Fuzzy search function
    function fuzzySearch(query) {
      if (!query.trim() || searchIndex.length === 0) return [];

      const lowerQuery = query.toLowerCase();
      const words = lowerQuery.split(/\s+/).filter(function(w) { return w.length > 0; });

      return searchIndex
        .map(function(post) {
          let score = 0;
          const lowerTitle = post.title.toLowerCase();
          const lowerDesc = post.description.toLowerCase();
          const lowerCategory = post.category.toLowerCase();
          const lowerTags = (post.tags || []).map(function(t) { return t.toLowerCase(); });

          for (let i = 0; i < words.length; i++) {
            const word = words[i];
            // Title match (highest priority)
            if (lowerTitle.includes(word)) {
              score += lowerTitle.startsWith(word) ? 10 : 5;
            }
            // Category match
            if (lowerCategory.includes(word)) {
              score += 4;
            }
            // Tag match
            if (lowerTags.some(function(t) { return t.includes(word); })) {
              score += 3;
            }
            // Description match
            if (lowerDesc.includes(word)) {
              score += 2;
            }
          }

          return { post: post, score: score };
        })
        .filter(function(item) { return item.score > 0; })
        .sort(function(a, b) { return b.score - a.score; })
        .slice(0, 10)
        .map(function(item) { return item.post; });
    }

    // Render search results
    function renderResults(results, query) {
      if (!resultsContainer) return;

      if (!query || !query.trim()) {
        resultsContainer.innerHTML =
          '<div class="search-empty">' +
            '<p>Start typing to search...</p>' +
            '<div class="search-tips">' +
              '<span><kbd>↑</kbd> <kbd>↓</kbd> to navigate</span>' +
              '<span><kbd>Enter</kbd> to select</span>' +
              '<span><kbd>ESC</kbd> to close</span>' +
            '</div>' +
          '</div>';
        return;
      }

      if (isLoading) {
        resultsContainer.innerHTML =
          '<div class="search-empty">' +
            '<p>Loading...</p>' +
          '</div>';
        return;
      }

      if (results.length === 0) {
        resultsContainer.innerHTML =
          '<div class="search-no-results">' +
            '<p>No results found for "' + query + '"</p>' +
          '</div>';
        return;
      }

      let html = '';
      for (let i = 0; i < results.length; i++) {
        const post = results[i];
        const isSelected = i === selectedIndex ? ' selected' : '';
        html += '<a href="' + post.href + '" class="search-result-item' + isSelected + '" data-index="' + i + '">';
        if (post.image) {
          html += '<img src="' + post.image + '" alt="" class="search-result-image" loading="lazy" />';
        }
        html += '<div class="search-result-content">';
        html += '<div class="search-result-category">' + post.category + '</div>';
        html += '<div class="search-result-title">' + post.title + '</div>';
        html += '<div class="search-result-description">' + post.description + '</div>';
        html += '</div></a>';
      }
      resultsContainer.innerHTML = html;
    }

    // Perform search
    function performSearch(query) {
      selectedIndex = -1;
      searchResults = fuzzySearch(query);
      renderResults(searchResults, query);
    }

    // Open modal
    function openSearch() {
      loadSearchIndex();
      if (modal) modal.classList.add('active');
      if (input) input.focus();
      document.body.style.overflow = 'hidden';
    }

    // Close modal
    function closeSearch() {
      if (modal) modal.classList.remove('active');
      if (input) input.value = '';
      selectedIndex = -1;
      searchResults = [];
      renderResults([], '');
      document.body.style.overflow = '';
    }

    // Navigate results
    function navigateResults(direction) {
      if (searchResults.length === 0) return;

      if (direction === 'down') {
        selectedIndex = selectedIndex < searchResults.length - 1 ? selectedIndex + 1 : 0;
      } else {
        selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : searchResults.length - 1;
      }

      renderResults(searchResults, input ? input.value : '');

      // Scroll selected item into view
      const selectedItem = resultsContainer ? resultsContainer.querySelector('.selected') : null;
      if (selectedItem) selectedItem.scrollIntoView({ block: 'nearest' });
    }

    // Select result
    function selectResult() {
      if (selectedIndex >= 0 && selectedIndex < searchResults.length) {
        window.location.href = searchResults[selectedIndex].href;
      }
    }

    // Event listeners
    document.addEventListener('keydown', function(e) {
      // Open with Cmd/Ctrl + K
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal && modal.classList.contains('active')) {
          closeSearch();
        } else {
          openSearch();
        }
      }

      // Handle navigation when modal is open
      if (modal && modal.classList.contains('active')) {
        if (e.key === 'Escape') {
          closeSearch();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          navigateResults('down');
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          navigateResults('up');
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
          e.preventDefault();
          selectResult();
        }
      }
    });

    // Search input handler
    if (input) {
      input.addEventListener('input', function(e) {
        const query = e.target.value;
        performSearch(query);
      });
    }

    // Close on backdrop click
    const backdrop = modal ? modal.querySelector('.search-backdrop') : null;
    if (backdrop) {
      backdrop.addEventListener('click', closeSearch);
    }

    // Click on result item
    if (resultsContainer) {
      resultsContainer.addEventListener('click', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item) {
          closeSearch();
        }
      });

      // Hover to select
      resultsContainer.addEventListener('mouseover', function(e) {
        const item = e.target.closest('.search-result-item');
        if (item) {
          const index = parseInt(item.getAttribute('data-index') || '-1', 10);
          if (index >= 0) {
            selectedIndex = index;
            renderResults(searchResults, input ? input.value : '');
          }
        }
      });
    }

    // Expose openSearch globally for the header button
    window.openSearch = openSearch;
  })();
</script>
